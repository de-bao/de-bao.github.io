<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    {% seo %}
    
    <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
    <link rel="alternate" type="application/rss+xml" title="{{ site.title }}" href="{{ '/feed.xml' | relative_url }}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ '/assets/favicon.svg' | relative_url }}">
    
    <!-- 字体图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="wrapper">
        <!-- 导航栏 -->
        <nav class="navbar">
            <div class="container">
                <!-- 时钟和天气 -->
                <div class="nav-weather-clock">
                    <div class="nav-clock-item">
                        <span class="nav-clock-date" id="nav-clock-date">2025年12月20日</span>
                        <span class="nav-clock-time" id="nav-clock-time">00:00:00</span>
                    </div>
                    <div class="nav-weather-item" id="nav-weather-item">
                        <span class="nav-weather-city-desc" id="nav-weather-city-desc">南京 --</span>
                        <span class="nav-weather-temp" id="nav-weather-temp">--°C~--°C</span>
                    </div>
                    <div class="nav-lang-item" id="nav-lang-item">
                        <button class="lang-dropdown-btn" id="lang-dropdown-btn">
                            <span id="lang-current">语言</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="lang-dropdown-menu" id="lang-dropdown-menu">
                            <button class="lang-option" data-lang="zh">中</button>
                            <button class="lang-option" data-lang="en">英</button>
                        </div>
                    </div>
                </div>
                <div class="nav-brand">
                    <a href="{{ '/' | relative_url }}" aria-label="返回首页">{{ site.title }}</a>
                </div>
                <ul class="nav-menu">
                    {% for item in site.navigation %}
                    <li>
                        <a href="{{ item.url | relative_url }}" {% if page.url == item.url %}class="active"{% endif %}>
                            {{ item.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                <button class="nav-toggle" aria-label="切换菜单" id="nav-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </nav>

        <!-- 主要内容 -->
        <main class="main-content">
            {{ content }}
        </main>

        <!-- 页脚 -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-section">
                        <h3>关于</h3>
                        <p>{{ site.description }}</p>
                    </div>
                    <div class="footer-section">
                        <h3>社交链接</h3>
                        <div class="social-links">
                            <a href="{{ site.social_links.github }}" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
                                <i class="fab fa-github"></i>
                            </a>
                            <a href="{{ site.social_links.zhihu }}" target="_blank" rel="noopener noreferrer" aria-label="知乎">
                                <i class="fab fa-zhihu"></i>
                            </a>
                            <a href="{{ site.social_links.csdn }}" target="_blank" rel="noopener noreferrer" aria-label="CSDN">
                                <i class="fas fa-blog"></i>
                            </a>
                        </div>
                    </div>
                    <div class="footer-section">
                        <h3>订阅</h3>
                        <p>
                            <a href="{{ '/feed.xml' | relative_url }}">RSS Feed</a>
                        </p>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; {{ 'now' | date: "%Y" }} {{ site.author.name }}. 保留所有权利.</p>
                    <p>由 <a href="https://pages.github.com/" target="_blank">GitHub Pages</a> 托管</p>
                </div>
            </div>
        </footer>
    </div>

    <script src="{{ '/assets/js/main.js' | relative_url }}"></script>
    <script>
        // 移动端菜单切换
        document.getElementById('nav-toggle')?.addEventListener('click', function() {
            const menu = document.querySelector('.nav-menu');
            menu.classList.toggle('active');
        });

        // 实时时钟 - 直接在页面底部执行，确保导航栏已渲染
        (function initClock() {
            function updateClock() {
                const navClockDateEl = document.getElementById('nav-clock-date');
                const navClockTimeEl = document.getElementById('nav-clock-time');
                if (navClockDateEl && navClockTimeEl) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const seconds = String(now.getSeconds()).padStart(2, '0');
                    
                    navClockDateEl.textContent = `${year}年${month}月${day}日`;
                    navClockTimeEl.textContent = `${hours}:${minutes}:${seconds}`;
                }
            }
            
            // 立即更新一次
            updateClock();
            // 每秒更新
            setInterval(updateClock, 1000);
        })();

        // 获取天气信息 - 直接在页面底部执行
        (function initWeather() {
            const cityName = '南京';
            const navWeatherCityDescEl = document.getElementById('nav-weather-city-desc');
            const navWeatherTempEl = document.getElementById('nav-weather-temp');
            
            function getWeather() {
                if (!navWeatherCityDescEl || !navWeatherTempEl) return;

                // 使用Open-Meteo免费API（更稳定）
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=32.0603&longitude=118.7969&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=Asia/Shanghai`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.current && data.daily) {
                            const current = data.current;
                            const daily = data.daily;
                            const tempMax = Math.round(daily.temperature_2m_max[0]);
                            const tempMin = Math.round(daily.temperature_2m_min[0]);
                            
                            // 天气代码转中文描述
                            const weatherCodes = {
                                0: '晴朗', 1: '大部分晴朗', 2: '部分多云', 3: '阴天',
                                45: '雾', 48: '霜雾', 51: '小雨', 53: '中雨', 55: '大雨',
                                61: '小雨', 63: '中雨', 65: '大雨', 71: '小雪', 73: '中雪', 75: '大雪',
                                80: '小雨', 81: '中雨', 82: '大雨', 85: '小雪', 86: '大雪',
                                95: '雷暴', 96: '雷暴冰雹', 99: '强雷暴冰雹'
                            };
                            const weatherDesc = weatherCodes[current.weather_code] || '未知';
                            
                            // 更新显示：第一行城市+天气状况，第二行温度范围
                            navWeatherCityDescEl.textContent = `${cityName} ${weatherDesc}`;
                            navWeatherTempEl.textContent = `${tempMin}°C~${tempMax}°C`;
                        } else {
                            throw new Error('天气数据格式错误');
                        }
                    })
                    .catch(error => {
                        console.error('获取天气失败:', error);
                        // 备用方案：使用wttr.in
                        fetch(`https://wttr.in/Nanjing?format=j1&lang=zh`)
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.current_condition && data.current_condition[0]) {
                                    const current = data.current_condition[0];
                                    const temp = current.temp_C;
                                    const tempMax = current.temp_C || temp;
                                    const tempMin = current.temp_C || temp;
                                    const desc = current.lang_zh ? current.lang_zh[0].value : (current.weatherDesc ? current.weatherDesc[0].value : '未知');
                                    
                                    // 更新显示：第一行城市+天气状况，第二行温度范围
                                    navWeatherCityDescEl.textContent = `${cityName} ${desc}`;
                                    navWeatherTempEl.textContent = `${tempMin}°C~${tempMax}°C`;
                                } else {
                                    navWeatherCityDescEl.textContent = `${cityName} --`;
                                    navWeatherTempEl.textContent = `--°C~--°C`;
                                }
                            })
                            .catch(() => {
                                navWeatherCityDescEl.textContent = `${cityName} --`;
                                navWeatherTempEl.textContent = `--°C~--°C`;
                            });
                    });
            }
            
            // 立即获取天气
            getWeather();
            // 每10分钟更新一次
            setInterval(getWeather, 10 * 60 * 1000);
        })();

        // 语言切换功能 - 使用Google Translate免费网页版
        (function initLanguage() {
            const langDropdownBtn = document.getElementById('lang-dropdown-btn');
            const langDropdownMenu = document.getElementById('lang-dropdown-menu');
            const langCurrent = document.getElementById('lang-current');
            const langItem = document.getElementById('nav-lang-item');
            const html = document.documentElement;
            
            // 从localStorage读取保存的语言，默认中文
            let currentLang = localStorage.getItem('lang') || 'zh';
            let translateWidget = null;
            let googleTranslateLoaded = false;
            
            // 更新当前语言显示
            function updateCurrentLang() {
                langCurrent.textContent = currentLang === 'en' ? '英' : '中';
                // 更新选项状态
                document.querySelectorAll('.lang-option').forEach(option => {
                    if (option.dataset.lang === currentLang) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }
            
            // 加载Google Translate
            function loadGoogleTranslate() {
                if (googleTranslateLoaded && window.google && window.google.translate) {
                    return Promise.resolve();
                }
                
                return new Promise((resolve, reject) => {
                    if (document.getElementById('google-translate-script')) {
                        // 等待Google Translate加载完成
                        const checkInterval = setInterval(() => {
                            if (window.google && window.google.translate) {
                                clearInterval(checkInterval);
                                googleTranslateLoaded = true;
                                resolve();
                            }
                        }, 100);
                        setTimeout(() => {
                            clearInterval(checkInterval);
                            if (!googleTranslateLoaded) {
                                reject(new Error('Google Translate加载超时'));
                            }
                        }, 5000);
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.id = 'google-translate-script';
                    script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
                    script.async = true;
                    script.onerror = () => reject(new Error('Google Translate脚本加载失败'));
                    document.head.appendChild(script);
                    
                    window.googleTranslateElementInit = function() {
                        googleTranslateLoaded = true;
                        resolve();
                    };
                });
            }
            
            // 切换语言
            async function switchLanguage(lang) {
                if (lang === currentLang) return;
                
                currentLang = lang;
                localStorage.setItem('lang', lang);
                html.lang = lang;
                updateCurrentLang();
                closeDropdown();
                
                if (lang === 'en') {
                    // 切换到英文，使用Google Translate
                    try {
                        await loadGoogleTranslate();
                        
                        // 创建翻译widget（如果还没有）
                        const container = document.getElementById('google_translate_element');
                        if (!translateWidget && container) {
                            translateWidget = new google.translate.TranslateElement({
                                pageLanguage: 'zh',
                                includedLanguages: 'en',
                                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                                autoDisplay: false
                            }, 'google_translate_element');
                        }
                        
                        // 等待widget创建完成，然后触发翻译
                        setTimeout(() => {
                            const select = document.querySelector('.goog-te-combo');
                            if (select) {
                                select.value = 'en';
                                select.dispatchEvent(new Event('change'));
                            } else {
                                // 如果select还没出现，重试
                                setTimeout(() => {
                                    const select2 = document.querySelector('.goog-te-combo');
                                    if (select2) {
                                        select2.value = 'en';
                                        select2.dispatchEvent(new Event('change'));
                                    }
                                }, 500);
                            }
                        }, 300);
                    } catch (error) {
                        console.error('翻译加载失败:', error);
                        alert('翻译功能暂时不可用，请稍后重试');
                    }
                } else {
                    // 切换回中文
                    const select = document.querySelector('.goog-te-combo');
                    if (select && select.value !== 'zh') {
                        select.value = 'zh';
                        select.dispatchEvent(new Event('change'));
                    }
                }
            }
            
            // 打开/关闭下拉菜单
            function toggleDropdown() {
                langItem.classList.toggle('active');
            }
            
            function closeDropdown() {
                langItem.classList.remove('active');
            }
            
            // 绑定事件
            langDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDropdown();
            });
            
            // 点击选项
            document.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const lang = option.dataset.lang;
                    switchLanguage(lang);
                });
            });
            
            // 点击外部关闭下拉菜单
            document.addEventListener('click', (e) => {
                if (!langItem.contains(e.target)) {
                    closeDropdown();
                }
            });
            
            // 初始化
            updateCurrentLang();
            html.lang = currentLang;
            
            // 如果默认是英文，自动触发翻译
            if (currentLang === 'en') {
                setTimeout(() => {
                    switchLanguage('en');
                }, 1500);
            }
        })();
    </script>
    <!-- Google Translate 容器（隐藏） -->
    <div id="google_translate_element" style="position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden;"></div>
</body>
</html>
