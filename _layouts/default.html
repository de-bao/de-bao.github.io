<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    {% seo %}
    
    <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
    <link rel="alternate" type="application/rss+xml" title="{{ site.title }}" href="{{ '/feed.xml' | relative_url }}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ '/assets/favicon.svg' | relative_url }}">
    
    <!-- 字体图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="wrapper">
        <!-- 导航栏 -->
        <nav class="navbar">
            <div class="container">
                <!-- 时钟和天气 -->
                <div class="nav-weather-clock">
                    <div class="nav-clock-item">
                        <span class="nav-clock-date" id="nav-clock-date">2025年12月20日</span>
                        <span class="nav-clock-time" id="nav-clock-time">00:00:00</span>
                    </div>
                    <div class="nav-weather-item" id="nav-weather-item">
                        <span class="nav-weather-city-desc" id="nav-weather-city-desc">南京 --</span>
                        <span class="nav-weather-temp" id="nav-weather-temp">--°C~--°C</span>
                    </div>
                    <div class="nav-lang-item" id="nav-lang-item" data-translate="no">
                        <button class="lang-dropdown-btn" id="lang-dropdown-btn">
                            <span id="lang-current" data-translate="no">语言</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="lang-dropdown-menu" id="lang-dropdown-menu">
                            <button class="lang-option" data-lang="zh" data-translate="no">中文</button>
                            <button class="lang-option" data-lang="en" data-translate="no">English</button>
                        </div>
                    </div>
                </div>
                <div class="nav-brand">
                    <a href="{{ '/' | relative_url }}" aria-label="返回首页">{{ site.title }}</a>
                </div>
                <ul class="nav-menu">
                    {% for item in site.navigation %}
                    <li>
                        <a href="{{ item.url | relative_url }}" {% if page.url == item.url %}class="active"{% endif %}>
                            {{ item.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
                <button class="nav-toggle" aria-label="切换菜单" id="nav-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </nav>

        <!-- 主要内容 -->
        <main class="main-content">
            {{ content }}
        </main>

        <!-- 页脚 -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-section">
                        <h3>关于</h3>
                        <p>{{ site.description }}</p>
                    </div>
                    <div class="footer-section">
                        <h3>社交链接</h3>
                        <div class="social-links">
                            <a href="{{ site.social_links.github }}" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
                                <i class="fab fa-github"></i>
                            </a>
                            <a href="{{ site.social_links.zhihu }}" target="_blank" rel="noopener noreferrer" aria-label="知乎">
                                <i class="fab fa-zhihu"></i>
                            </a>
                            <a href="{{ site.social_links.csdn }}" target="_blank" rel="noopener noreferrer" aria-label="CSDN">
                                <i class="fas fa-blog"></i>
                            </a>
                        </div>
                    </div>
                    <div class="footer-section">
                        <h3>订阅</h3>
                        <p>
                            <a href="{{ '/feed.xml' | relative_url }}">RSS Feed</a>
                        </p>
                    </div>
                </div>
                <div class="footer-bottom">
                    <p>&copy; {{ 'now' | date: "%Y" }} {{ site.author.name }}. 保留所有权利.</p>
                    <p>由 <a href="https://pages.github.com/" target="_blank">GitHub Pages</a> 托管</p>
                </div>
            </div>
        </footer>
    </div>

    <script src="{{ '/assets/js/main.js' | relative_url }}"></script>
    <script>
        // 移动端菜单切换
        document.getElementById('nav-toggle')?.addEventListener('click', function() {
            const menu = document.querySelector('.nav-menu');
            menu.classList.toggle('active');
        });

        // 实时时钟 - 直接在页面底部执行，确保导航栏已渲染
        (function initClock() {
            function updateClock() {
                const navClockDateEl = document.getElementById('nav-clock-date');
                const navClockTimeEl = document.getElementById('nav-clock-time');
                if (navClockDateEl && navClockTimeEl) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const seconds = String(now.getSeconds()).padStart(2, '0');
                    
                    navClockDateEl.textContent = `${year}年${month}月${day}日`;
                    navClockTimeEl.textContent = `${hours}:${minutes}:${seconds}`;
                }
            }
            
            // 立即更新一次
            updateClock();
            // 每秒更新
            setInterval(updateClock, 1000);
        })();

        // 获取天气信息 - 直接在页面底部执行
        (function initWeather() {
            const cityName = '南京';
            const navWeatherCityDescEl = document.getElementById('nav-weather-city-desc');
            const navWeatherTempEl = document.getElementById('nav-weather-temp');
            
            function getWeather() {
                if (!navWeatherCityDescEl || !navWeatherTempEl) return;

                // 使用Open-Meteo免费API（更稳定）
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=32.0603&longitude=118.7969&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=Asia/Shanghai`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.current && data.daily) {
                            const current = data.current;
                            const daily = data.daily;
                            const tempMax = Math.round(daily.temperature_2m_max[0]);
                            const tempMin = Math.round(daily.temperature_2m_min[0]);
                            
                            // 天气代码转中文描述
                            const weatherCodes = {
                                0: '晴朗', 1: '大部分晴朗', 2: '部分多云', 3: '阴天',
                                45: '雾', 48: '霜雾', 51: '小雨', 53: '中雨', 55: '大雨',
                                61: '小雨', 63: '中雨', 65: '大雨', 71: '小雪', 73: '中雪', 75: '大雪',
                                80: '小雨', 81: '中雨', 82: '大雨', 85: '小雪', 86: '大雪',
                                95: '雷暴', 96: '雷暴冰雹', 99: '强雷暴冰雹'
                            };
                            const weatherDesc = weatherCodes[current.weather_code] || '未知';
                            
                            // 更新显示：第一行城市+天气状况，第二行温度范围
                            navWeatherCityDescEl.textContent = `${cityName} ${weatherDesc}`;
                            navWeatherTempEl.textContent = `${tempMin}°C~${tempMax}°C`;
                        } else {
                            throw new Error('天气数据格式错误');
                        }
                    })
                    .catch(error => {
                        console.error('获取天气失败:', error);
                        // 备用方案：使用wttr.in
                        fetch(`https://wttr.in/Nanjing?format=j1&lang=zh`)
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.current_condition && data.current_condition[0]) {
                                    const current = data.current_condition[0];
                                    const temp = current.temp_C;
                                    const tempMax = current.temp_C || temp;
                                    const tempMin = current.temp_C || temp;
                                    const desc = current.lang_zh ? current.lang_zh[0].value : (current.weatherDesc ? current.weatherDesc[0].value : '未知');
                                    
                                    // 更新显示：第一行城市+天气状况，第二行温度范围
                                    navWeatherCityDescEl.textContent = `${cityName} ${desc}`;
                                    navWeatherTempEl.textContent = `${tempMin}°C~${tempMax}°C`;
                                } else {
                                    navWeatherCityDescEl.textContent = `${cityName} --`;
                                    navWeatherTempEl.textContent = `--°C~--°C`;
                                }
                            })
                            .catch(() => {
                                navWeatherCityDescEl.textContent = `${cityName} --`;
                                navWeatherTempEl.textContent = `--°C~--°C`;
                            });
                    });
            }
            
            // 立即获取天气
            getWeather();
            // 每10分钟更新一次
            setInterval(getWeather, 10 * 60 * 1000);
        })();

        // 语言切换功能 - 使用MyMemory Translation API（免费）
        (function initLanguage() {
            const langDropdownBtn = document.getElementById('lang-dropdown-btn');
            const langDropdownMenu = document.getElementById('lang-dropdown-menu');
            const langCurrent = document.getElementById('lang-current');
            const langItem = document.getElementById('nav-lang-item');
            const html = document.documentElement;
            
            // 从localStorage读取保存的语言，默认中文
            let currentLang = localStorage.getItem('lang') || 'zh';
            let originalTexts = new Map(); // 保存原始文本，用于切换回中文
            
            // 更新当前语言显示
            function updateCurrentLang() {
                langCurrent.textContent = currentLang === 'en' ? 'English' : '中文';
                // 更新选项状态
                document.querySelectorAll('.lang-option').forEach(option => {
                    if (option.dataset.lang === currentLang) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }
            
            // 使用MyMemory Translation API翻译文本（主API）
            async function translateTextMyMemory(text, fromLang = 'zh', toLang = 'en') {
                try {
                    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${fromLang}|${toLang}&de=debao.cpc@gmail.com`;
                    console.log('[翻译调试] MyMemory请求URL:', url);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    console.log('[翻译调试] MyMemory响应状态:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('[翻译调试] MyMemory响应数据:', data);
                    
                    if (data.responseStatus === 200 && data.responseData) {
                        console.log('[翻译调试] MyMemory翻译成功:', text, '->', data.responseData.translatedText);
                        return data.responseData.translatedText;
                    }
                    throw new Error('Translation failed: ' + JSON.stringify(data));
                } catch (error) {
                    console.error('[翻译调试] MyMemory翻译错误:', error);
                    return null;
                }
            }
            
            // 使用LibreTranslate API翻译文本（备用API）
            async function translateTextLibreTranslate(text, fromLang = 'zh', toLang = 'en') {
                try {
                    // 使用公共的LibreTranslate实例
                    const url = 'https://libretranslate.de/translate';
                    console.log('[翻译调试] LibreTranslate请求...');
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            q: text,
                            source: fromLang,
                            target: toLang,
                            format: 'text'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('[翻译调试] LibreTranslate响应:', data);
                    
                    if (data.translatedText) {
                        console.log('[翻译调试] LibreTranslate翻译成功:', text, '->', data.translatedText);
                        return data.translatedText;
                    }
                    throw new Error('Translation failed: ' + JSON.stringify(data));
                } catch (error) {
                    console.error('[翻译调试] LibreTranslate翻译错误:', error);
                    return null;
                }
            }
            
            // 统一的翻译函数，自动尝试多个API
            async function translateText(text, fromLang = 'zh', toLang = 'en') {
                // 先尝试MyMemory
                let result = await translateTextMyMemory(text, fromLang, toLang);
                if (result) return result;
                
                // 如果MyMemory失败，尝试LibreTranslate
                console.log('[翻译调试] MyMemory失败，尝试LibreTranslate...');
                result = await translateTextLibreTranslate(text, fromLang, toLang);
                if (result) return result;
                
                // 都失败了
                console.error('[翻译调试] 所有翻译API都失败了');
                return null;
            }
            
            // 提取需要翻译的文本节点
            function getTextNodes(element) {
                const textNodes = [];
                const walker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: function(node) {
                            // 跳过script、style、noscript等标签内的文本
                            const parent = node.parentElement;
                            if (!parent) return NodeFilter.FILTER_REJECT;
                            const tagName = parent.tagName.toLowerCase();
                            if (['script', 'style', 'noscript', 'code', 'pre'].includes(tagName)) {
                                return NodeFilter.FILTER_REJECT;
                            }
                            // 跳过标记为不翻译的元素
                            if (parent.closest('[data-translate="no"]') || parent.hasAttribute('data-translate') && parent.getAttribute('data-translate') === 'no') {
                                return NodeFilter.FILTER_REJECT;
                            }
                            // 跳过语言切换相关的元素
                            if (parent.closest('.nav-lang-item') || parent.closest('.resume-lang-item')) {
                                return NodeFilter.FILTER_REJECT;
                            }
                            // 只翻译非空文本
                            if (node.textContent.trim().length > 0) {
                                return NodeFilter.FILTER_ACCEPT;
                            }
                            return NodeFilter.FILTER_REJECT;
                        }
                    }
                );
                
                let node;
                while (node = walker.nextNode()) {
                    textNodes.push(node);
                }
                return textNodes;
            }
            
            // 翻译页面内容
            async function translatePage() {
                console.log('[翻译调试] 开始翻译页面');
                console.log('[翻译调试] 浏览器信息:', navigator.userAgent);
                console.log('[翻译调试] 当前语言:', currentLang);
                
                // 如果已经翻译过，先恢复中文
                if (originalTexts.size > 0) {
                    console.log('[翻译调试] 恢复中文，原始文本数量:', originalTexts.size);
                    restoreChinese();
                }
                
                // 翻译整个页面，包括导航栏和页脚
                const textNodes = getTextNodes(document.body);
                console.log('[翻译调试] 找到文本节点数量:', textNodes.length);
                
                if (textNodes.length === 0) {
                    console.warn('[翻译调试] 没有找到需要翻译的文本节点');
                    alert('未找到需要翻译的内容，请检查页面是否已加载完成');
                    return;
                }
                
                // 显示翻译提示
                const loadingMsg = document.createElement('div');
                loadingMsg.id = 'translate-loading';
                loadingMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#6366f1;color:white;padding:12px 20px;border-radius:8px;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
                loadingMsg.textContent = '正在翻译页面...';
                document.body.appendChild(loadingMsg);
                
                try {
                    // 先测试API连接
                    console.log('[翻译调试] 测试API连接...');
                    const testResult = await translateText('测试', 'zh', 'en');
                    if (!testResult) {
                        console.warn('[翻译调试] API连接测试失败，将直接尝试翻译（可能部分失败）');
                        // 不直接抛出错误，继续尝试翻译，可能部分API可用
                    } else {
                        console.log('[翻译调试] API连接测试成功:', testResult);
                    }
                    
                    // 批量翻译（每次最多10个节点，避免超过API限制）
                    const batchSize = 10;
                    let translatedCount = 0;
                    let failedCount = 0;
                    
                    for (let i = 0; i < textNodes.length; i += batchSize) {
                        const batch = textNodes.slice(i, i + batchSize);
                        console.log(`[翻译调试] 处理批次 ${Math.floor(i/batchSize) + 1}/${Math.ceil(textNodes.length/batchSize)}, 节点数: ${batch.length}`);
                        
                        const promises = batch.map(async (node) => {
                            const text = node.textContent.trim();
                            if (!text || text.length === 0) return;
                            
                            // 跳过已经是英文的文本（简单判断）
                            if (/^[a-zA-Z0-9\s\.,!?;:'"()\[\]{}\-]+$/.test(text) && text.length > 3) {
                                return;
                            }
                            
                            // 保存原始文本（只保存一次）
                            if (!originalTexts.has(node)) {
                                originalTexts.set(node, text);
                            }
                            
                            // 翻译文本
                            const translated = await translateText(text);
                            if (translated && translated !== text) {
                                node.textContent = translated;
                                translatedCount++;
                            } else if (!translated) {
                                failedCount++;
                            }
                        });
                        
                        await Promise.all(promises);
                        // 添加延迟避免请求过快
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                    console.log('[翻译调试] 翻译完成，成功:', translatedCount, '失败:', failedCount);
                    
                    // 移除加载提示
                    loadingMsg.remove();
                    
                    // 显示完成提示
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:12px 20px;border-radius:8px;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
                    successMsg.textContent = `翻译完成！已翻译 ${translatedCount} 处文本${failedCount > 0 ? `，${failedCount} 处失败` : ''}`;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                    
                } catch (error) {
                    console.error('[翻译调试] 翻译过程错误:', error);
                    console.error('[翻译调试] 错误堆栈:', error.stack);
                    loadingMsg.remove();
                    
                    // 显示详细错误信息
                    const errorMsg = document.createElement('div');
                    errorMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#ef4444;color:white;padding:12px 20px;border-radius:8px;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:400px;';
                    errorMsg.innerHTML = `翻译失败: ${error.message}<br><small>请打开浏览器控制台（F12）查看详细错误信息</small>`;
                    document.body.appendChild(errorMsg);
                    setTimeout(() => errorMsg.remove(), 5000);
                    
                    // 如果API失败，尝试使用浏览器翻译
                    tryBrowserTranslation();
                }
            }
            
            // 尝试使用浏览器翻译功能
            function tryBrowserTranslation() {
                // 检测是否在Chrome/Edge中
                const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                const isEdge = /Edg/.test(navigator.userAgent);
                
                // 显示友好的提示信息
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#ef4444;color:white;padding:16px 24px;border-radius:8px;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:450px;line-height:1.6;';
                errorMsg.innerHTML = `
                    <strong>自动翻译API暂时不可用</strong><br>
                    <small style="opacity:0.9;">
                    ${isChrome || isEdge ? 
                        '请使用浏览器内置翻译：<br>1. 点击地址栏右侧的翻译图标<br>2. 或右键页面选择"翻译为英语"' : 
                        '正在为您打开Google Translate...'
                    }
                    </small>
                `;
                document.body.appendChild(errorMsg);
                
                if (isChrome || isEdge) {
                    // Chrome/Edge：提示使用浏览器翻译
                    setTimeout(() => {
                        errorMsg.remove();
                        const useBrowser = confirm(
                            '自动翻译API暂时不可用。\n\n' +
                            '是否使用浏览器内置翻译功能？\n\n' +
                            '点击"确定"后，请在浏览器地址栏右侧点击翻译图标，或右键页面选择"翻译为英语"。\n\n' +
                            '点击"取消"将自动在新标签页打开Google Translate。'
                        );
                        
                        if (!useBrowser) {
                            const translateUrl = `https://translate.google.com/translate?sl=zh&tl=en&u=${encodeURIComponent(window.location.href)}`;
                            window.open(translateUrl, '_blank');
                        }
                    }, 3000);
                } else {
                    // 其他浏览器，自动打开Google Translate
                    setTimeout(() => {
                        errorMsg.remove();
                        const translateUrl = `https://translate.google.com/translate?sl=zh&tl=en&u=${encodeURIComponent(window.location.href)}`;
                        window.open(translateUrl, '_blank');
                    }, 2000);
                }
            }
            
            // 恢复中文
            function restoreChinese() {
                originalTexts.forEach((originalText, node) => {
                    node.textContent = originalText;
                });
                originalTexts.clear();
            }
            
            // 切换语言
            async function switchLanguage(lang) {
                if (lang === currentLang) return;
                
                console.log('[翻译调试] 切换语言:', lang);
                
                currentLang = lang;
                localStorage.setItem('lang', lang);
                html.lang = lang;
                updateCurrentLang();
                closeDropdown();
                
                if (lang === 'en') {
                    // 翻译为英文
                    console.log('[翻译调试] 开始翻译为英文');
                    await translatePage();
                } else {
                    // 切换回中文
                    console.log('[翻译调试] 切换回中文');
                    restoreChinese();
                }
            }
            
            // 暴露调试函数到全局，方便在控制台调用
            window.debugTranslation = {
                testAPI: async () => {
                    console.log('测试翻译API...');
                    const result = await translateText('你好', 'zh', 'en');
                    console.log('测试结果:', result);
                    return result;
                },
                getTextNodes: () => {
                    const nodes = getTextNodes(document.body);
                    console.log('文本节点数量:', nodes.length);
                    console.log('前10个节点:', nodes.slice(0, 10).map(n => n.textContent.trim()));
                    return nodes;
                },
                checkNetwork: async () => {
                    try {
                        const response = await fetch('https://api.mymemory.translated.net/get?q=test&langpair=zh|en');
                        console.log('网络测试:', response.status, response.statusText);
                        const data = await response.json();
                        console.log('API响应:', data);
                        return { success: true, data };
                    } catch (error) {
                        console.error('网络测试失败:', error);
                        return { success: false, error };
                    }
                }
            };
            
            // 打开/关闭下拉菜单
            function toggleDropdown() {
                langItem.classList.toggle('active');
            }
            
            function closeDropdown() {
                langItem.classList.remove('active');
            }
            
            // 绑定事件
            langDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDropdown();
            });
            
            // 点击选项
            document.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const lang = option.dataset.lang;
                    switchLanguage(lang);
                });
            });
            
            // 点击外部关闭下拉菜单
            document.addEventListener('click', (e) => {
                if (!langItem.contains(e.target)) {
                    closeDropdown();
                }
            });
            
            // 初始化
            updateCurrentLang();
            html.lang = currentLang;
            
            // 如果页面加载时已经是英文状态，自动翻译
            if (currentLang === 'en') {
                // 等待页面完全加载后再翻译
                if (document.readyState === 'complete') {
                    setTimeout(() => translatePage(), 500);
                } else {
                    window.addEventListener('load', () => {
                        setTimeout(() => translatePage(), 500);
                    });
                }
            }
        })();
    </script>
    
    <!-- ClustrMaps Globe Widget -->
    <script type="text/javascript" id="clstr_globe" src="//clustrmaps.com/globe.js?d=I_kcB5dWikqitdTbwCNpq76yRHZY-el4GrjzEGxRpFI"></script>
</body>
</html>
